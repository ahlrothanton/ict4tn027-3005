# H6 - Hash

Solutions for week six [assignments](https://terokarvinen.com/2021/hakkerointi-kurssi-tunkeutumistestaus-ict4tn027-3005/#h6-viimeista-viedaan).

## Table of Contents

* [Assignments](#assignements)
  * [z) Read and reference materials](#z-read-and-reference-materials)
  * [a) On top of Google](#a-on-top-of-Google)
  * [b) Create three hashes and crack them with Hashcat](#b-create-three-hashes-and-crack-them-with-hashcat)
  * [c) Create a wordlist](#c-create-a-wordlist)
  * [d) Try wordlist attack](#d-try-wordlist-attack)
  * [e) Crack some files password protection](#e-crack-some-files-password-protection)
  * [g) Crack multiple password protected files](#g-crack-multiple-password-protected-files)
* [References](#references)

---

## Assignments

### z) Read and reference materials

- [Santos et al 2017: Security Penetration Testing - The Art of Hacking Series LiveLessons: Lesson 6: Hacking User Credentials](https://learning.oreilly.com/videos/security-penetration-testing/9780134833989/9780134833989-sptt_00_06_00_00)
  - Authentication and Authorization Mechanisms
    - Credentials are commonly stored in some sort of database, eg. Postgresql, Active Directory, etc.
    - Credentials can be encrypted in-transit or at-rest
    - Users should use complex passwords and enable multi faction authentication
  - Authentication and Authorization Attacks
    - weak credentials
      - Default credentials
      - Password reuse
      - Simple passwords generated by humans, eg. Password1
      - Admin password is gold
      - Passwords can be dumped from system memory
    - Capture credentials over the network
      - MITM
    - Brute Force
      - find real user accounts to brute force
        - SMB/NetBios/SAMBA
  - Password Storage Mechanisms
    - Hashing is a common way to protect passwords
    - One way hashing is not encryption
    - Salted passwords are harder to crack
  - Password Storage Vulnerabilities
    - GPUs decrease time to crack passwords
    - Weak algoritms
    - Hashes are not salted, eg. Windows
    - Rainbow tables
    - People tend to use same passwords
  - Improving password security
    - passwords are not sufficent & hashing algoritms are not enough
    - Salt your hashes
    - Create strong passwords everywhere
    - Use two factor authentication
    - Use certificate based authentication
    - Better Randomness

---

## a) On top of Google

I left a comment and got a response:

"Thank you! Your comment has been queued for moderation."

---

## b) Create three hashes and crack them with Hashcat

I used password kissa123 and hashed it with sha1, sha256 and md5. We then crack it with JohnTheRipper.

- sha1
  - create the hash

    ```shell
    echo -n kissa123 | openssl sha1 > sha1.txt
    ```

  - crack the hash with johntheripper

    ```shell
    john sha1.txt
    ```

  - hash was cracked to kissa123

    ```text
    Warning: detected hash type "Raw-SHA1", but the string is also recognized as "Raw-SHA1-AxCrypt"
    Use the "--format=Raw-SHA1-AxCrypt" option to force loading these as that type instead
    Warning: detected hash type "Raw-SHA1", but the string is also recognized as "Raw-SHA1-Linkedin"
    Use the "--format=Raw-SHA1-Linkedin" option to force loading these as that type instead
    Warning: detected hash type "Raw-SHA1", but the string is also recognized as "ripemd-160"
    Use the "--format=ripemd-160" option to force loading these as that type instead
    Warning: detected hash type "Raw-SHA1", but the string is also recognized as "has-160"
    Use the "--format=has-160" option to force loading these as that type instead
    Using default input encoding: UTF-8
    Loaded 1 password hash (Raw-SHA1 [SHA1 256/256 AVX2 8x])
    Warning: no OpenMP support for this hash type, consider --fork=2
    Proceeding with single, rules:Single
    Press 'q' or Ctrl-C to abort, almost any other key for status
    Almost done: Processing the remaining buffered candidate passwords, if any.
    Proceeding with wordlist:/usr/share/john/password.lst, rules:Wordlist
    Warning: Only 6 candidates left, minimum 8 needed for performance.
    Proceeding with incremental:ASCII
    kissa123         (?)
    1g 0:00:01:11 DONE 3/3 (2021-05-10 04:21) 0.01401g/s 29756Kp/s 29756Kc/s 29756KC/s kissa123..kissa126
    Use the "--show --format=Raw-SHA1" options to display all of the cracked passwords reliably
    Session completed
    ```

  - sha256
    - create the hash

    ```shell
    echo -n kissa123 | openssl sha256 | awk '{print $2}' > sha256.txt
    ```

    - crack the hash with johntheripper

      ```shell
      john --format=raw-sha256 sha256.txt
      ```

    - hash was cracked to kissa123

      ```text
      Using default input encoding: UTF-8
      Loaded 1 password hash (Raw-SHA256 [SHA256 256/256 AVX2 8x])
      Warning: poor OpenMP scalability for this hash type, consider --fork=2
      Will run 2 OpenMP threads
      Proceeding with single, rules:Single
      Press 'q' or Ctrl-C to abort, almost any other key for status
      Almost done: Processing the remaining buffered candidate passwords, if any.
      Proceeding with wordlist:/usr/share/john/password.lst, rules:Wordlist
      Proceeding with incremental:ASCII
      kissa123         (?)
      1g 0:00:01:21 DONE 3/3 (2021-05-10 05:21) 0.01234g/s 26209Kp/s 26209Kc/s 26209KC/s kissirlz..kishbed1
      Use the "--show --format=Raw-SHA256" options to display all of the cracked passwords reliably
      Session completed
      ```

  - md5
    - create the hash

      ```shell
      echo -n kissa123 | openssl md5 | awk '{print $2}' > md5.txt
      ```

    - crack the hash with johntheripper

      ```shell
      john --format=Raw-MD5 md5.txt
      ```

    - hash was cracked to kissa123

      ```text
      Using default input encoding: UTF-8
      Loaded 1 password hash (Raw-MD5 [MD5 256/256 AVX2 8x3])
      Warning: no OpenMP support for this hash type, consider --fork=2
      Proceeding with single, rules:Single
      Press 'q' or Ctrl-C to abort, almost any other key for status
      Almost done: Processing the remaining buffered candidate passwords, if any.
      Proceeding with wordlist:/usr/share/john/password.lst, rules:Wordlist
      Proceeding with incremental:ASCII
      kissa123         (?)
      1g 0:00:00:42 DONE 3/3 (2021-05-10 05:26) 0.02336g/s 49618Kp/s 49618Kc/s 49618KC/s kissalet..kissa133
      Use the "--show --format=Raw-MD5" options to display all of the cracked passwords reliably
      Session completed
      ```

Doing this was quite slow on a Kali Linux running on a VirtualBox virtual machine, but cracking these hashes is stupidly easy and fast on a real machine.

---

## c) Create a wordlist

- I took first 100 entries from rockyou wordlist from Kali and appended few of my own entries to the wordlist.

  ```shell
  zcat /usr/share/wordlists/rockyou.txt.gz | head -100 > wordlist.txt
  ```

---

## d) Try wordlist attack

- I setup WebGoat with my [Vagrant setup](../Vagrantfile)
- I used Hydra to bruteforce the password of WebGoat using my wordlist. I had created user testi123 with password testi123 on there.

  ```shell
  hydra -l testi123 -P wordlist.txt 172.28.128.4 -s 8080 http-post-form "/WebGoat/login:username=^USER^&password=^PASS^:F=error" -V
  ```

- Hydra found the correct password using the wordlist

  ```shell
  [ATTEMPT] target 172.28.128.4 - login "testi123" - pass "testi123" - 102 of 102 [child 3] (0/0)
  [8080][http-post-form] host: 172.28.128.4   login: testi123   password: testi123
  1 of 1 target successfully completed, 1 valid password found
  Hydra (https://github.com/vanhauser-thc/thc-hydra) finished at 2021-05-11 05:41:46
  ```

---

## e) Crack some files password protection

- I created password protected MS Word [document](./e_top_secret.docx) and I followed a guide from an [article](https://null-byte.wonderhowto.com/how-to/crack-password-protected-microsoft-office-files-including-word-docs-excel-spreadsheets-0193959/) on how to crack office passwords
- I downloaded [office2john tool](https://github.com/openwall/john/blob/bleeding-jumbo/run/office2john.py)

  ```shell
  https://github.com/openwall/john/blob/bleeding-jumbo/run/office2john.py
  ```

- run the tool to extract the password hash in format john can handle

  ```shell
  python office2john.py e_top_secret.docx > word_hash.txt
  ```

- we then use JohnTheRipper to bruteforce the file password using the same [wordlist](./c_wordlist.txt) we created earlier

  ```shell
  john word_hash.txt --wordlist=c_wordlist.txt
  ```

- I tried also with Hashcat and it worked as well

  ```shell
  hashcat -a 0 -m 9600 --username word_hash.txt c_wordlist.txt
  ```

- Both of these solutions found the password from wordlist relatively fast

---

## f) Try wordlist on other targets than web

- Simple example against SSH on other Vagrant machine on my network

  ```shell
  hydra -l vagrant -P c_wordlist.txt 172.28.128.4 ssh
  ```

Hydra finds the correct password using dictionary attack.

---

## g) Crack multiple password protected files

- In addition to the [MS Word document](#e-crack-some-files-password-protection), I created two encrypted files([zip](./g_secret.zip) and [pdf](./g_secret.pdf)).
- I started with the zipped file by getting the hash in correct format for john

  ```shell
  zip2john g_secret.zip > g_secret_zip_hash.txt
  ```

- I then used john to brute force the password with a wordlist

  ```shell
  john --wordlist=c_wordlist.txt g_secret_zip_hash.txt
  ```

- john found the password relatively fast. I'll figure out how to crack the encrypted pdf file next

- again we need to get hash in correct format

  ```shell
  perl pdf2john.pl g_secret.pdf > g_secret_pdf_hash.txt
  ```

- then we use john to brute force the password

  ```shell
  john --wordlist=c_wordlist.txt g_secret_pdf_hash.txt
  ```

- again john found the password really fast

---

## References

- [Terokarvinen.com, H6 assignment](https://terokarvinen.com/2021/hakkerointi-kurssi-tunkeutumistestaus-ict4tn027-3005/#h6-viimeista-viedaan)
- [Santos et al 2017: Security Penetration Testing - The Art of Hacking Series LiveLessons: Lesson 6: Hacking User Credentials](https://learning.oreilly.com/videos/security-penetration-testing/9780134833989/9780134833989-sptt_00_06_00_00)
- [null-byte.wonderhowto.com, Crack Password Protected Microsoft Office Files](https://null-byte.wonderhowto.com/how-to/crack-password-protected-microsoft-office-files-including-word-docs-excel-spreadsheets-0193959/)
- [Openwall, Office2John](https://github.com/openwall/john/blob/bleeding-jumbo/run/office2john.py)
